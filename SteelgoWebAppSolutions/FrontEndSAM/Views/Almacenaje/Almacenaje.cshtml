@{
    ViewBag.Title = "Almacenaje";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section breadcrumb {
    <li>
        <a href="@Url.Action("landing", "Home")"><span id="Almacenaje0001"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardRecepcionAlmacenaje", "DashboardRecepcionAlmacenaje")"><span id="Almacenaje0024"></span></a>
    </li>
    <li>
        <a href="@Url.Action("DashboardRecepcionAlmacenaje", "DashboardRecepcionAlmacenaje")"><span id="Almacenaje0025"></span></a>
    </li>
    <li class="active">
        <a href="@Url.Action("Almacenaje", "Almacenaje")"><span id="Almacenaje0002"></span></a>
    </li>
}

<div id="formaAlmacenaje" class="form clearfix col-xs-12 col-sm-12 col-md-12 col-lg-12">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="formNav clearfix">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="button-section editButtonSection">
                            <div class="btn-group save-group">
                                <button id="Guardar" onclick="javascript:void(0);" type="button" class="btn btn-yellow"><span id="Almacenaje0003"></span></button>
                                @*<button id="Editar" onclick="javascript:void(0);" type="button" class="btn btn-yellow" style="display: none"><span id="Almacenaje0004"></span></button>
                                <button id="dropdown-toggle" type="button" class="btn btn-yellow dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caretWhite"></span>
                                </button>*@
                            </div>
                            <a id="Cancelar" class="btn btn-black"><span id="Almacenaje0005"></span></a>
                        </div>
                        <div class="button-section actionButtonSection">
                            <div class="dropdown action-group">
                                <a id="Acciones" data-target="#" href="#" data-toggle="dropdown" role="button" ariahaspopup="true" aria-expanded="false" class="btn btn-default">
                                    <span id="Almacenaje0006"></span>
                                    <span class="caretBlue"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="Acciones">
                                    @*<li><a id="irListado" href="#"><span id="Almacenaje0007"></span></a></li>*@
                                    <li class="incidencia"><a id="IrIncidencia" href="#"><span id="Almacenaje0008"></span></a></li>
                                </ul>
                            </div>
                        </div>
                        <a id="Imprimir" href="#" class="btn btn-fadeBlue actionButtonSection disabled"></a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-11">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="row">
                                <div id="ProyectoDiv" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0009"></label>
                                    <input id="ProyectoID" class="" />
                                </div>
                                <div id="OrdenAlmacenajeDiv" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0010"></label>
                                    <input id="OrdenAlmacenaje" class="" />
                                </div>
                                <div id="ItemCodeDiv" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0011"></label>
                                    <input id="ItemCode" class="" />
                                </div>
                                <div id="NumeroUnicoDiv" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0012"></label>
                                    <input id="NumeroUnico" class="" />
                                </div>
                                <div id="Diametro1Div" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0013"></label>
                                    <input id="Diametro1" class="general-input" disabled />
                                </div>
                                <div id="Diametro2Div" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                                    <label id="Almacenaje0014"></label>
                                    <input id="Diametro2" class="general-input" disabled />
                                </div>                                
                            </div>

                        </div>
                    </div>                    
                </div>
            </div>
            <div class="row">
                <div class="addedSection clearfix">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-11">
                        <div id="RackDiv" class="form-group col-xs-12 col-sm-6 col-md-6 col-lg-3">
                            <label id="Almacenaje0015"></label>
                            <input id="Rack" class="general-input" />
                        </div>
                        <div class="form-group col-xs-12 col-sm-6 col-md-4 col-lg-3">
                            <div class="row">
                                <div id="todosDiv" class="col-xs-6 col-sm-3 col-md-3 col-lg-3">
                                    <label id="Almacenaje0016" class="centered"></label>
                                    <input id="todos" class="" type="radio" name="radio" checked value="1">
                                </div>
                                <div id="SinLocalizacionDiv" class="col-xs-6 col-sm-9 col-md-9 col-lg-9">
                                    <label id="Almacenaje0017" class="centered"></label>
                                    <input id="SinLocalizacion" class="" type="radio" name="radio" value="2" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div id="grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" id="ChecksAlmacenaje" value="1" />@*1 todos 2 sin localizacion*@ 
    </div>

    <ul id="menu" class="incidencia">
        <li><span id="Almacenaje0023"></span>
        </li>
    </ul>

</div>

<script>
    @section JavascriptDocumentReadyHomeCookie {
        Cookies.set("home", true, { path: '/' });
        Cookies.set("navegacion", "24", { path: '/' });
    }

    @section JavascriptGlobalVariables {
    var Proyecto = {}, OrdenAlmacenaje = {},
        ItemCode = {}, NumeroUnico = {},
        resultadoJson = "";
    var params={};
    window.location.search!=="" ? window.location.href.split("?")[1].split("&").forEach(function(n){params[n.split("=")[0]]=n.split("=")[1]}) : params=null;
    var _almacenaje = "@Url.Action("Almacenaje", "Almacenaje")";
    var _incidenciasURL = "@Url.Action("Incidencias", "Incidencias")";

    var $AlmacenajeModel = {
        listContainer: {
            create: ".save-group",
            list: "#grid",
            detail: ".detailLink",
            destroy: ".k-grid-Cancelar",
            createIncidence: ".incidencia"
        },
        properties: {
            proyecto: {
                visible: "#ProyectoDiv",
                editable: "#ProyectoID",
                required: "#ProyectoID"
            },
            ordenalmacenaje: {
                visible: "#OrdenAlmacenajeDiv",
                editable: "#OrdenAlmacenaje",
                required: "#OrdenAlmacenaje"
            },
            itemcode: {
                visible: "#ItemCodeDiv",
                editable: "#ItemCode",
                required: "#ItemCode"
            },
            numerounico: {
                visible: "#NumeroUnicoDiv",
                editable: "#NumeroUnico",
                required: "#NumeroUnico"
            },
            diametro1: {
                visible: "#Diametro1Div",
                editable: "#Diametro1",
                required: "#Diametro1"
            },
            diametro2: {
                visible: "#Diametro2Div",
                editable: "#Diametro2",
                required: "#Diametro2"
            },
            rack: {
                visible: "#RackDiv",
                editable: "#Rack",
                required: "#Rack"
            },
            todos: {
                visible: "#todosDiv",
                editable: "#todos",
                required: "#todos"
            },
            sinlocalizacion: {
                visible: "#SinLocalizacionDiv",
                editable: "#SinLocalizacion",
                required: "#SinLocalizacion"
            }
        }
    };
    }

    @section JavascriptGlobalFunctions {
    function changeLanguageCall() {
        var tmp = removeGrid($("#grid"));
        CargarGridAlmacenaje();
        $("#grid").data("kendoGrid").dataSource.data(tmp);
    };

    function CargaInicial() {
        $("#Guardar").click(function () { Guardar(); });
        $("#Cancelar").click(function () { Cancelar(); });
        $("#IrIncidencia").click(function () { Incidencias(); });

        $("#ProyectoID").kendoComboBox({
            dataTextField: "Nombre",
            dataValueField: "ProyectoID",
            select: function (e) {
            },
            change: function (e) {
                var dataItem = this.dataItem();
                dataItem!==undefined ? CargarProyecto(dataItem.ProyectoID, dataItem.Nombre):CargarProyecto("", "");
                var value = this.value();
                LimpiarCamposProyecto();
                if (!value || this.selectedIndex == -1) {
                    messageindexKendoCombobox(this);
                    Proyecto = {};
                    this.value("");
                } else {
                    ObtenerOrdenesAlmacenaje();
                };
            },
            filter: "contains",
            dataBound: function(e){checkIfOne(this);},
        });
        ObtenerProyecto();

        $("#OrdenAlmacenaje").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            select: function (e) {
            },
            change: function (e) {
                var dataItem = this.dataItem();
                dataItem!==undefined ? CargarOrdenAlmacenaje(dataItem.id, dataItem.value):CargarOrdenAlmacenaje("", "");
                var value = this.value();
                LimpiarCamposOrdenAlmacenaje();

                if (!value || this.selectedIndex == -1) {
                    messageindexKendoCombobox(this);
                    OrdenAlmacenaje = {};
                    this.value("");
                } else {
                    ObtenerItemCodes();
                };
                FiltrarDatos();
            },
            dataBound: function(e){checkIfOne(this);},
            filter: "contains",
        });

        $("#ItemCode").kendoComboBox({
            dataTextField: "value",
            dataValueField: "id",
            select: function (e) {
            },
            change: function (e) {
                var dataItem = this.dataItem();
                dataItem!==undefined ? CargarItemCode(dataItem.id, dataItem.value):CargarItemCode("", "");
                var value = this.value();
                LimpiarCamposItemCode();
                if (!value || this.selectedIndex == -1) {
                    messageindexKendoCombobox(this);
                    ItemCode = {};
                    this.value("");
                } else {
                    ObtenerDiametros();
                    ObtenerNumerosUnicos();
                };
                FiltrarDatos();
            },
            dataBound: function(e){checkIfOne(this);},
            filter: "contains",
        });

        $("#NumeroUnico").kendoComboBox({
            dataTextField: "NumeroUnico",
            dataValueField: "NumeroUnicoID",
            select: function (e) {
            },
            change: function (e) {
                var dataItem = this.dataItem();
                dataItem!==undefined ? CargarNumeroUnico(dataItem.NumeroUnicoID, dataItem.NumeroUnico):CargarNumeroUnico("", "");
                var value = this.value();
                if (!value || this.selectedIndex == -1) {
                    messageindexKendoCombobox(this);
                    NumeroUnico = {};
                    this.value("");
                }
                FiltrarDatos();
            },
            filter: "contains",
            dataBound: function(e){checkIfOne(this);},
        });

        $("#Rack").keydown(function (e) {
            if (e.keyCode == 13) {
                PlancharRack(this.value);
                $("#Rack").val("");
            }
        });

        $('input:radio').click(function () {
            if ($(this).val() === '1') {
                $("#ChecksAlmacenaje").val(1);
                FiltrarDatos();
            } else if ($(this).val() === '2') {
                $("#ChecksAlmacenaje").val(2);
                FiltrarDatos();
            }
        });

    };

    function CargarProyecto(id, value) {
        Proyecto = {};
        Proyecto = { ProyectoID: id, Nombre: value };
    };

    function CargarOrdenAlmacenaje(id, value) {
        OrdenAlmacenaje = {};
        OrdenAlmacenaje = { OrdenAlmacenajeID: id, Nombre: value };
    };
    function CargarItemCode(id, value) {
        ItemCode = {};
        ItemCode = { ItemCodeID: id, Nombre: value };
    };
    function CargarNumeroUnico(id, value) {
        NumeroUnico = {};
        NumeroUnico = { NumeroUnicoID: id, Nombre: value };
    };

    function ObtenerProyecto() {
        $Proyecto.Proyecto.read({ token: Cookies.get("token") }).done(function (result) {
            ControlErroresObjetosComboBox("ProyectoID", result);
            fromParam($("#ProyectoID").data("kendoComboBox"),"ProyectoID",params!==null && params.ProyectoID!==null ? params.ProyectoID : null);
        });
    };

    function ObtenerOrdenesAlmacenaje() {//Se Obtienen los numeros unicos y los item codes
        //loadingStart();
        $Almacenaje.Almacenaje.read({ ProyectoID: Proyecto.ProyectoID, token: Cookies.get("token") }).done(function (result) {
            if (Error(result)) {
                ControlErroresObjetosComboBox("OrdenAlmacenaje", result);
                fromParam($("#OrdenAlmacenaje").data("kendoComboBox"),"id",params!==null && params.OrdenAlmacenajeID!==null ? params.OrdenAlmacenajeID : null);
            }
            //loadingStop();
        });

    };


    function ObtenerItemCodes() {//Se Obtienen los numeros unicos y los item codes
        //loadingStart();
        $Almacenaje.Almacenaje.read({ proyectoID: Proyecto.ProyectoID, ordenalmacenajeID: OrdenAlmacenaje.OrdenAlmacenajeID, token: Cookies.get("token") }).done(function (result) {
            if (Error(result)) {
                ControlErroresObjetosComboBox("ItemCode", result.ListadoItemCode);
                resultadoJson = result.ListadoAlmacenaje;
                if ($("#grid").data("kendoGrid")) {
                    if (resultadoJson.length > 0) {
                        $("#grid").data("kendoGrid").dataSource.data(resultadoJson);
                        $("#grid").data("kendoGrid").dataSource.page(1);
                    } else {
                        $("#grid").data("kendoGrid").dataSource.data([]);
                        $("#grid").data("kendoGrid").dataSource.page(0);
                    };
                };
                AsignarPaginaActualCookie();
                applySecurityPolicy(false);
            }
            //loadingStop();
        });

    };
    function AsignarPaginaActualCookie() {
        Cookies.set("navegacion", "24", { path: '/' });
    }
      
    function ObtenerDiametros() {
        //loadingStart();
        $Almacenaje.Almacenaje.read({
           itemCodeid: ItemCode.ItemCodeID, token: Cookies.get("token")
        }).done(function (result) {
            if (Error(result)) {
                $("#Diametro1").val(result.Diametro1);
                $("#Diametro2").val(result.Diametro2);
            }
            //loadingStop();
        });
    };
    function ObtenerNumerosUnicos() {
        //loadingStart();
        $Almacenaje.Almacenaje.read({
            ProyectoID: Proyecto.ProyectoID, ordenalmacenajeID: OrdenAlmacenaje.OrdenAlmacenajeID,
            itemCodeid: ItemCode.ItemCodeID, token: Cookies.get("token")
        }).done(function (result) {
            if (Error(result)) {
                ControlErroresObjetosComboBox("NumeroUnico", result);
            }
            //loadingStop();
        });
    };

    function LimpiarCamposProyecto() {
        OrdenAlmacenaje = {};
        ItemCode = {};
        NumeroUnico = {};
        $("#OrdenAlmacenaje").data("kendoComboBox").value("");
        $("#ItemCode").data("kendoComboBox").value("");
        $("#NumeroUnico").data("kendoComboBox").value("");
        $("#Diametro1").val("");
        $("#Diametro2").val("");
        $("#Rack").val("");
        $("#NumeroUnico").data("kendoComboBox").dataSource.data([]);
        $("#ItemCode").data("kendoComboBox").dataSource.data([]);
        $("#OrdenAlmacenaje").data("kendoComboBox").dataSource.data([]);
        if ($("#grid").data("kendoGrid")){
            $("#grid").data("kendoGrid").dataSource.data([]);
            $("#grid").data("kendoGrid").dataSource.page(0);
        }
    };

    function LimpiarCamposOrdenAlmacenaje() {
        ItemCode = {};
        NumeroUnico = {};
        $("#ItemCode").data("kendoComboBox").value("");
        $("#NumeroUnico").data("kendoComboBox").value("");
        $("#Diametro1").val("");
        $("#Diametro2").val("");
        $("#Rack").val("");
        $("#NumeroUnico").data("kendoComboBox").dataSource.data([]);
        $("#ItemCode").data("kendoComboBox").dataSource.data([]);
        if ($("#grid").data("kendoGrid")) {
            $("#grid").data("kendoGrid").dataSource.data([]);
            $("#grid").data("kendoGrid").dataSource.page(0);
        }
    };

    function LimpiarCamposItemCode() {
        NumeroUnico = {};
        $("#NumeroUnico").data("kendoComboBox").value("");
        $("#NumeroUnico").data("kendoComboBox").dataSource.data([]);
        $("#Diametro1").val("");
        $("#Diametro2").val("");
        $("#Rack").val("");
    };


    function FiltrarDatos() {
        var ChecksAlmacenaje = $("#ChecksAlmacenaje").val();
        var ds = $("#grid").data("kendoGrid").dataSource;
        var filters = [];

        ds.filter({});

        if (ChecksAlmacenaje == "2") {
            var new_filter = { field: "Rack", operator: "eq", value: "" };
            filters.push(new_filter);
        }

        if (ItemCode.ItemCodeID) {
            var new_filter = { field: "ItemCodeID", operator: "Contains", value: ItemCode.ItemCodeID ? ItemCode.ItemCodeID : "" };
            filters.push(new_filter);
        };

        if (NumeroUnico.NumeroUnicoID) {
            var new_filter = { field: "NumeroUnicoID", operator: "Contains", value: NumeroUnico.NumeroUnicoID ? NumeroUnico.NumeroUnicoID : "" };
            filters.push(new_filter);
        };

        ds.filter(filters);
    };


    function PlancharRack(value) {
        var filters = $("#grid").data("kendoGrid").dataSource.filter();
        var allData = $("#grid").data("kendoGrid").dataSource.data();
        var query = new kendo.data.Query(allData);
        var result = query.filter(filters).data;
        var datasource = result;

        $(datasource).each(function () {
            this.set("Rack", value);
        });
    };

    function CargarGridAlmacenaje() {
        $("#grid").kendoGrid({
            dataSource: {
                data: resultadoJson,
                schema: {
                    model: {
                        fields: {
                            ItemCodeID: { type: "string", editable: false },
                            NumeroUnicoID: { type: "string", editable: false },
                            NumeroUnico: { type: "string", editable: false },
                            Rack: { type: "string", editable: true }
                        }
                    }
                },
                pageSize: 10,
                serverPaging: false,
                serverFiltering: false,
                serverSorting: false
            },
            autoHeight: true,
            sortable: true,
            scrollable: false,
            selectable: true,
            editable: {
                mode: "incell",
                confirmation: false
            },
            pageable: {
                refresh: false,
                pageSizes: [10, 15, 20],
                info: false,
                input: false,
                numeric: true,
                buttonCount: 2
            },
            filterable: getKendoGridFilterable($("#language").data("kendoDropDownList").value()),
            columns: [
                { field: "NumeroUnico", title: _dictionary.Almacenaje0018[$("#language").data("kendoDropDownList").value()]},
                { field: "Rack", title: _dictionary.Almacenaje0019[$("#language").data("kendoDropDownList").value()] },
                { field: "ItemCodeID", title: _dictionary.Almacenaje0020[$("#language").data("kendoDropDownList").value()], hidden: true },
                { field: "NumeroUnicoID", title: _dictionary.Almacenaje0018[$("#language").data("kendoDropDownList").value()], hidden: true },
            ],
            dataBound: function (e) {
                //$(".k-grid input.k-textbox").prop('readonly', true);
                //$(".k-grid td .k-button").text('');
                //$(".k-grid td:first-child, .k-grid td:last-child").css('text-overflow', 'clip');
                checkTH($("#grid").data("kendoGrid"));
                quickHeadFilter($("#grid").data("kendoGrid"));
            }
        });

        $("#menu").kendoContextMenu({
            target: "#grid",
            filter: "td",
            select: function (e) {
                var grid = $("#grid").data("kendoGrid");
                var select = grid.select();
                var data = grid.dataItem(select);

                window.open(_incidenciasURL + "?leng=" + $("#language").data("kendoDropDownList").value() + "&LevantarIncidencia=1&ReferenciaID=" + data.NumeroUnicoID + "&TipoIncidencia=9&Clasificacion=1");
            }
        });

        $("#grid").on("mousedown", "tr[role='row']", function (e) {
            $('#grid').data("kendoGrid").select(e.target.parentElement);
            $("#grid thead .k-state-selected> .k-link").css({
                "color": "black"
            });
        });
    };
       
    function ControlErroresObjetosComboBox(control, result) {
        if (Error(result)) {
            $("#" + control).data("kendoComboBox").dataSource.data(result);
        } else {
            $("#" + control).data("kendoComboBox").dataSource.data([]);
        };
    };

    function validarRequeridosFormaAlmacenaje() {
        var bool = true;
        $("#formaAlmacenaje .security_required").each(function (i, elem) {
            if (elem.tagName.toLowerCase() != 'label') {
                if (!$(this).val()) {
                    bool = false;
                    $(this).closest("div").find("label").addClass("error");
                } else {
                    $(this).closest("div").find("label").removeClass("error");
                };
            };
        });
        return bool;
    };

    function Guardar() {
        //loadingStart();
        if (validarRequeridosFormaAlmacenaje()) {
            var datasource = $("#grid").data("kendoGrid").dataSource.data();
            var Listado = { OrdenAlmacenajeID: "", Items: "" };
            Listado.OrdenAlmacenajeID = OrdenAlmacenaje.OrdenAlmacenajeID;
            Listado.NumerosUnicos = ListadoAGuardar(datasource);

            $Almacenaje.Almacenaje.update(Listado, { token: $.cookie("token") }).done(function (result) {
                Error(result);
                displayMessage("notificationslabel0056", "", '0');
                //loadingStop();
            });
        } else {
            displayMessage("notificationslabel0031", "", '1');
            //loadingStop();
        }
    };

    function Cancelar() {
        window.location.href = _almacenaje + "?leng=" + $("#language").data("kendoDropDownList").value();
    };

    function Incidencias() {
        var OrdenAlmacenajeID = OrdenAlmacenaje.OrdenAlmacenajeID ? OrdenAlmacenaje.OrdenAlmacenajeID : "-1";
        window.open(_incidenciasURL + "?leng=" + $("#language").data("kendoDropDownList").value() + "&LevantarIncidencia=1&ReferenciaID=" + OrdenAlmacenajeID + "&TipoIncidencia=8&Clasificacion=1");
    };

    function Error(data) {
        if (data.ReturnCode) {
            if (data.ReturnCode != 200) {
                if (data.ReturnCode == 401) {
                    removeUserSession();
                    return false;
                } else {
                    displayMessage("notificationslabel0008", data.ReturnMessage, '2');
                    return false;
                }
            } else {
                return true;
            }
        } else {
            return true;
        }
    };
    }

    function ListadoAGuardar(datasource) {
        var Listado = {};
        for (var i = 0; i < datasource.length; i++) {
            var NumeroUnico = datasource[i].NumeroUnicoID;
            var Rack = datasource[i].Rack;

            Listado[i] = { NumeroUnicoID: NumeroUnico, Rack: Rack };
        };
        return Listado;
    };
    
    function fromParam(widget,paramname,param){
        if(param!==null){
            widget.select(function(dataItem) {
                return dataItem[paramname] === param;
            });
            widget.trigger("change");
        }
    }

    @section JavascriptDocumentReadyFunctions {
        $authorizationModel["Almacenaje"] = $AlmacenajeModel;
        CargaInicial();
    }

</script>